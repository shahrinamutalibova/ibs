{"ast":null,"code":"import { deepMix } from '@antv/util';\nimport { column, columnOf, inferredColumn, maybeColumnOf } from './utils/helper';\nimport { normalizeComparator, createGroups, applyOrder } from './utils/order';\n/**\n * The stack transform group marks into series by color channel,\n * and then produce new y channel for each series by specified order,\n * say to form vertical \"stacks\" by specified channels.\n */\nexport const StackY = (options = {}) => {\n  const {\n    groupBy = 'x',\n    orderBy = null,\n    reverse = false,\n    y: fromY = 'y',\n    y1: fromY1 = 'y1',\n    series = true\n  } = options;\n  return (I, mark) => {\n    const {\n      data,\n      encode,\n      style = {}\n    } = mark;\n    const [Y, fy] = columnOf(encode, 'y');\n    const [Y1, fy1] = columnOf(encode, 'y1');\n    const [S] = series ? maybeColumnOf(encode, 'series', 'color') : columnOf(encode, 'color');\n    // Create groups and apply specified order for each group.\n    const groups = createGroups(groupBy, I, mark);\n    const createComparator = normalizeComparator(orderBy);\n    const comparator = createComparator(data, Y, S);\n    if (comparator) applyOrder(groups, comparator);\n    // Stack y channels to produce new y and y1 channel.\n    const newY = new Array(I.length);\n    const newY1 = new Array(I.length);\n    const TY = new Array(I.length);\n    const F = [];\n    const L = [];\n    for (const G of groups) {\n      if (reverse) G.reverse();\n      // For range interval with specified y and y1.\n      const start = Y1 ? +Y1[G[0]] : 0;\n      // Split positive indices of Y and negative Y.\n      const PG = [];\n      const NG = [];\n      for (const i of G) {\n        const y = TY[i] = +Y[i] - start;\n        if (y < 0) NG.push(i);else if (y >= 0) PG.push(i);\n      }\n      // Store the first and last layer.\n      const FG = PG.length > 0 ? PG : NG;\n      const LG = NG.length > 0 ? NG : PG;\n      let i = PG.length - 1;\n      let j = 0;\n      // Find the last non-zero index.\n      while (i > 0 && Y[FG[i]] === 0) i--;\n      // Find the first non-zero index.\n      while (j < LG.length - 1 && Y[LG[j]] === 0) j++;\n      F.push(FG[i]);\n      L.push(LG[j]);\n      // Stack negative y in reverse order.\n      let ny = start;\n      for (const i of NG.reverse()) {\n        const y = TY[i];\n        ny = newY[i] = (newY1[i] = ny) + y;\n      }\n      // Stack positive y in input order.\n      let py = start;\n      for (const i of PG) {\n        const y = TY[i];\n        if (y > 0) py = newY[i] = (newY1[i] = py) + y;else newY[i] = newY1[i] = py;\n      }\n    }\n    // Only set top radius for the first layer,\n    // and set bottom radius for the last layer.\n    const FS = new Set(F);\n    const LS = new Set(L);\n    // Choose new y or y1 channel as the new y channel.\n    const V = fromY === 'y' ? newY : newY1;\n    const V1 = fromY1 === 'y' ? newY : newY1;\n    return [I, deepMix({}, mark, {\n      encode: {\n        y0: inferredColumn(Y, fy),\n        y: column(V, fy),\n        y1: column(V1, fy1)\n      },\n      style: Object.assign({\n        first: (_, i) => FS.has(i),\n        last: (_, i) => LS.has(i)\n      }, style)\n    })];\n  };\n};\nStackY.props = {};","map":{"version":3,"names":["deepMix","column","columnOf","inferredColumn","maybeColumnOf","normalizeComparator","createGroups","applyOrder","StackY","options","groupBy","orderBy","reverse","y","fromY","y1","fromY1","series","I","mark","data","encode","style","Y","fy","Y1","fy1","S","groups","createComparator","comparator","newY","Array","length","newY1","TY","F","L","G","start","PG","NG","i","push","FG","LG","j","ny","py","FS","Set","LS","V","V1","y0","Object","assign","first","_","has","last","props"],"sources":["transform/stackY.ts"],"sourcesContent":[null],"mappings":"AAAA,SAASA,OAAO,QAAQ,YAAY;AAGpC,SACEC,MAAM,EACNC,QAAQ,EACRC,cAAc,EACdC,aAAa,QACR,gBAAgB;AACvB,SAASC,mBAAmB,EAAEC,YAAY,EAAEC,UAAU,QAAQ,eAAe;AAI7E;;;;;AAKA,OAAO,MAAMC,MAAM,GAAsBA,CAACC,OAAO,GAAG,EAAE,KAAI;EACxD,MAAM;IACJC,OAAO,GAAG,GAAG;IACbC,OAAO,GAAG,IAAI;IACdC,OAAO,GAAG,KAAK;IACfC,CAAC,EAAEC,KAAK,GAAG,GAAG;IACdC,EAAE,EAAEC,MAAM,GAAG,IAAI;IACjBC,MAAM,GAAG;EAAI,CACd,GAAGR,OAAO;EACX,OAAO,CAACS,CAAC,EAAEC,IAAI,KAAI;IACjB,MAAM;MAAEC,IAAI;MAAEC,MAAM;MAAEC,KAAK,GAAG;IAAE,CAAE,GAAGH,IAAI;IACzC,MAAM,CAACI,CAAC,EAAEC,EAAE,CAAC,GAAGtB,QAAQ,CAACmB,MAAM,EAAE,GAAG,CAAC;IACrC,MAAM,CAACI,EAAE,EAAEC,GAAG,CAAC,GAAGxB,QAAQ,CAACmB,MAAM,EAAE,IAAI,CAAC;IACxC,MAAM,CAACM,CAAC,CAAC,GAAGV,MAAM,GACdb,aAAa,CAACiB,MAAM,EAAE,QAAQ,EAAE,OAAO,CAAC,GACxCnB,QAAQ,CAACmB,MAAM,EAAE,OAAO,CAAC;IAE7B;IACA,MAAMO,MAAM,GAAGtB,YAAY,CAACI,OAAO,EAAEQ,CAAC,EAAEC,IAAI,CAAC;IAC7C,MAAMU,gBAAgB,GAAGxB,mBAAmB,CAACM,OAAO,CAAC;IACrD,MAAMmB,UAAU,GAAGD,gBAAgB,CAACT,IAAI,EAAEG,CAAC,EAAEI,CAAC,CAAC;IAC/C,IAAIG,UAAU,EAAEvB,UAAU,CAACqB,MAAM,EAAEE,UAAU,CAAC;IAE9C;IACA,MAAMC,IAAI,GAAG,IAAIC,KAAK,CAACd,CAAC,CAACe,MAAM,CAAC;IAChC,MAAMC,KAAK,GAAG,IAAIF,KAAK,CAACd,CAAC,CAACe,MAAM,CAAC;IACjC,MAAME,EAAE,GAAG,IAAIH,KAAK,CAACd,CAAC,CAACe,MAAM,CAAC;IAC9B,MAAMG,CAAC,GAAG,EAAE;IACZ,MAAMC,CAAC,GAAG,EAAE;IACZ,KAAK,MAAMC,CAAC,IAAIV,MAAM,EAAE;MACtB,IAAIhB,OAAO,EAAE0B,CAAC,CAAC1B,OAAO,EAAE;MACxB;MACA,MAAM2B,KAAK,GAAGd,EAAE,GAAG,CAACA,EAAE,CAACa,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;MAEhC;MACA,MAAME,EAAE,GAAG,EAAE;MACb,MAAMC,EAAE,GAAG,EAAE;MACb,KAAK,MAAMC,CAAC,IAAIJ,CAAC,EAAE;QACjB,MAAMzB,CAAC,GAAIsB,EAAE,CAACO,CAAC,CAAC,GAAG,CAACnB,CAAC,CAACmB,CAAC,CAAC,GAAGH,KAAM;QACjC,IAAI1B,CAAC,GAAG,CAAC,EAAE4B,EAAE,CAACE,IAAI,CAACD,CAAC,CAAC,CAAC,KACjB,IAAI7B,CAAC,IAAI,CAAC,EAAE2B,EAAE,CAACG,IAAI,CAACD,CAAC,CAAC;;MAG7B;MACA,MAAME,EAAE,GAAGJ,EAAE,CAACP,MAAM,GAAG,CAAC,GAAGO,EAAE,GAAGC,EAAE;MAClC,MAAMI,EAAE,GAAGJ,EAAE,CAACR,MAAM,GAAG,CAAC,GAAGQ,EAAE,GAAGD,EAAE;MAClC,IAAIE,CAAC,GAAGF,EAAE,CAACP,MAAM,GAAG,CAAC;MACrB,IAAIa,CAAC,GAAG,CAAC;MACT;MACA,OAAOJ,CAAC,GAAG,CAAC,IAAInB,CAAC,CAACqB,EAAE,CAACF,CAAC,CAAC,CAAC,KAAK,CAAC,EAAEA,CAAC,EAAE;MACnC;MACA,OAAOI,CAAC,GAAGD,EAAE,CAACZ,MAAM,GAAG,CAAC,IAAIV,CAAC,CAACsB,EAAE,CAACC,CAAC,CAAC,CAAC,KAAK,CAAC,EAAEA,CAAC,EAAE;MAC/CV,CAAC,CAACO,IAAI,CAACC,EAAE,CAACF,CAAC,CAAC,CAAC;MACbL,CAAC,CAACM,IAAI,CAACE,EAAE,CAACC,CAAC,CAAC,CAAC;MAEb;MACA,IAAIC,EAAE,GAAGR,KAAK;MACd,KAAK,MAAMG,CAAC,IAAID,EAAE,CAAC7B,OAAO,EAAE,EAAE;QAC5B,MAAMC,CAAC,GAAGsB,EAAE,CAACO,CAAC,CAAC;QACfK,EAAE,GAAGhB,IAAI,CAACW,CAAC,CAAC,GAAG,CAACR,KAAK,CAACQ,CAAC,CAAC,GAAGK,EAAE,IAAIlC,CAAC;;MAGpC;MACA,IAAImC,EAAE,GAAGT,KAAK;MACd,KAAK,MAAMG,CAAC,IAAIF,EAAE,EAAE;QAClB,MAAM3B,CAAC,GAAGsB,EAAE,CAACO,CAAC,CAAC;QACf,IAAI7B,CAAC,GAAG,CAAC,EAAEmC,EAAE,GAAGjB,IAAI,CAACW,CAAC,CAAC,GAAG,CAACR,KAAK,CAACQ,CAAC,CAAC,GAAGM,EAAE,IAAInC,CAAC,CAAC,KACzCkB,IAAI,CAACW,CAAC,CAAC,GAAGR,KAAK,CAACQ,CAAC,CAAC,GAAGM,EAAE;;;IAIhC;IACA;IACA,MAAMC,EAAE,GAAG,IAAIC,GAAG,CAACd,CAAC,CAAC;IACrB,MAAMe,EAAE,GAAG,IAAID,GAAG,CAACb,CAAC,CAAC;IAErB;IACA,MAAMe,CAAC,GAAGtC,KAAK,KAAK,GAAG,GAAGiB,IAAI,GAAGG,KAAK;IACtC,MAAMmB,EAAE,GAAGrC,MAAM,KAAK,GAAG,GAAGe,IAAI,GAAGG,KAAK;IACxC,OAAO,CACLhB,CAAC,EACDlB,OAAO,CAAC,EAAE,EAAEmB,IAAI,EAAE;MAChBE,MAAM,EAAE;QACNiC,EAAE,EAAEnD,cAAc,CAACoB,CAAC,EAAEC,EAAE,CAAC;QACzBX,CAAC,EAAEZ,MAAM,CAACmD,CAAC,EAAE5B,EAAE,CAAC;QAChBT,EAAE,EAAEd,MAAM,CAACoD,EAAE,EAAE3B,GAAG;OACnB;MACDJ,KAAK,EAAAiC,MAAA,CAAAC,MAAA;QACHC,KAAK,EAAEA,CAACC,CAAC,EAAEhB,CAAC,KAAKO,EAAE,CAACU,GAAG,CAACjB,CAAC,CAAC;QAC1BkB,IAAI,EAAEA,CAACF,CAAC,EAAEhB,CAAC,KAAKS,EAAE,CAACQ,GAAG,CAACjB,CAAC;MAAC,GACtBpB,KAAK;KAEX,CAAC,CACH;EACH,CAAC;AACH,CAAC;AAEDd,MAAM,CAACqD,KAAK,GAAG,EAAE"},"metadata":{},"sourceType":"module","externalDependencies":[]}