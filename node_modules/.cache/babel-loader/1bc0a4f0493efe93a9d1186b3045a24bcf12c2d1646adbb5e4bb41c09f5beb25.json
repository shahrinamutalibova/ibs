{"ast":null,"code":"var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { isNumber } from '@antv/util';\nimport { Marker } from '@antv/component';\nimport { line } from 'd3-shape';\nimport { createElement } from '../../utils/createElement';\nimport { applyStyle } from '../utils';\nimport { subObject } from '../../utils/helper';\nimport { select } from '../../utils/selection';\nimport { dist } from '../../utils/vector';\nfunction getConnectorPoint(shape) {\n  const {\n    min: [x0, y0],\n    max: [x1, y1]\n  } = shape.getLocalBounds();\n  let x = 0;\n  let y = 0;\n  if (x0 > 0) x = x0;\n  if (x1 < 0) x = x1;\n  if (y0 > 0) y = y0;\n  if (y1 < 0) y = y1;\n  return [x, y];\n}\nfunction inferBackgroundBounds(textShape, padding = []) {\n  const [top = 0, right = 0, bottom = top, left = right] = padding;\n  const container = textShape.parentNode;\n  const angle = container.getEulerAngles();\n  container.setEulerAngles(0);\n  const {\n    min,\n    halfExtents\n  } = textShape.getLocalBounds();\n  const [x, y] = min;\n  const [hw, hh] = halfExtents;\n  container.setEulerAngles(angle);\n  return {\n    x: x - left,\n    y: y - top,\n    width: hw * 2 + left + right,\n    height: hh * 2 + top + bottom\n  };\n}\nconst cos = (p0, p1, p2) => {\n  const a = dist(p0, p1);\n  const b = dist(p1, p2);\n  const c = dist(p2, p0);\n  return (Math.pow(a, 2) + Math.pow(b, 2) - Math.pow(c, 2)) / (2 * a * b);\n};\nfunction inferConnectorPath(shape, points, controlPoints, coordCenter) {\n  const [[x0, y0], [x1, y1]] = points;\n  const [x, y] = getConnectorPoint(shape);\n  // Straight connector line.\n  if (x0 === x1 && y0 === y1) {\n    return line()([[0, 0], [x, y]]);\n  }\n  const P = [[x0 - x1, y0 - y1]].concat(controlPoints.length ? controlPoints : [[0, 0]]);\n  const p0 = [coordCenter[0] - x1, coordCenter[1] - y1];\n  const [p1, p2] = P;\n  // If angle is smaller than 90, which will cause connector overlap with element.\n  if (cos(p0, p1, p2) > 0) {\n    const x2 = (() => {\n      const {\n        min,\n        max\n      } = shape.getLocalBounds();\n      // A(x1,y2) perpendicular to B(x2,y2) => x1*x2 + y1*y2 = 0\n      const vx = p1[0] + (p1[1] - p0[1]) * (p1[1] - 0) / (p1[0] - p0[0]);\n      if (max[0] < p0[0]) return Math.min(max[0], vx);\n      return Math.max(min[0], vx);\n    })();\n    P.splice(1, 1, [x2, 0]);\n  }\n  return line()(P);\n}\nexport const Advance = createElement(g => {\n  const _a = g.attributes,\n    {\n      className,\n      // Do not pass className\n      class: _c,\n      transform,\n      rotate,\n      labelTransform,\n      labelTransformOrigin,\n      x,\n      y,\n      x0 = x,\n      y0 = y,\n      text,\n      background,\n      connector,\n      startMarker,\n      endMarker,\n      coordCenter,\n      innerHTML\n    } = _a,\n    rest = __rest(_a, [\"className\", \"class\", \"transform\", \"rotate\", \"labelTransform\", \"labelTransformOrigin\", \"x\", \"y\", \"x0\", \"y0\", \"text\", \"background\", \"connector\", \"startMarker\", \"endMarker\", \"coordCenter\", \"innerHTML\"]);\n  // Position is invalid, do not render the UI,\n  // or clear previous elements.\n  if ([x, y, x0, y0].some(v => !isNumber(v))) {\n    g.children.forEach(d => d.remove());\n    return;\n  }\n  const _b = subObject(rest, 'background'),\n    {\n      padding\n    } = _b,\n    backgroundStyle = __rest(_b, [\"padding\"]);\n  const _d = subObject(rest, 'connector'),\n    {\n      points = []\n    } = _d,\n    connectorStyle = __rest(_d, [\"points\"]);\n  const endPoints = [[+x0, +y0], [+x, +y]];\n  let textShape;\n  // Use html to customize advance text.\n  if (innerHTML) {\n    textShape = select(g).maybeAppend('html', 'html', className).style('zIndex', 0).style('innerHTML', innerHTML).call(applyStyle, Object.assign({\n      transform: labelTransform,\n      transformOrigin: labelTransformOrigin\n    }, rest)).node();\n  } else {\n    textShape = select(g).maybeAppend('text', 'text').style('zIndex', 0).style('text', text).call(applyStyle, Object.assign({\n      textBaseline: 'middle',\n      transform: labelTransform,\n      transformOrigin: labelTransformOrigin\n    }, rest)).node();\n  }\n  const rect = select(g).maybeAppend('background', 'rect').style('zIndex', -1).call(applyStyle, inferBackgroundBounds(textShape, padding)).call(applyStyle, background ? backgroundStyle : {}).node();\n  const connectorPath = inferConnectorPath(rect, endPoints, points, coordCenter);\n  const markerStart = startMarker && new Marker({\n    id: 'startMarker',\n    style: Object.assign({\n      x: 0,\n      y: 0\n    }, subObject(rest, 'startMarker'))\n  });\n  const markerEnd = endMarker && new Marker({\n    id: 'endMarker',\n    style: Object.assign({\n      x: 0,\n      y: 0\n    }, subObject(rest, 'endMarker'))\n  });\n  select(g).maybeAppend('connector', 'path').style('zIndex', 0).style('path', connectorPath).style('markerStart', markerStart).style('markerEnd', markerEnd).call(applyStyle, connector ? connectorStyle : {});\n});","map":{"version":3,"names":["isNumber","Marker","line","createElement","applyStyle","subObject","select","dist","getConnectorPoint","shape","min","x0","y0","max","x1","y1","getLocalBounds","x","y","inferBackgroundBounds","textShape","padding","top","right","bottom","left","container","parentNode","angle","getEulerAngles","setEulerAngles","halfExtents","hw","hh","width","height","cos","p0","p1","p2","a","b","c","Math","pow","inferConnectorPath","points","controlPoints","coordCenter","P","concat","length","x2","vx","splice","Advance","g","_a","attributes","className","class","_c","transform","rotate","labelTransform","labelTransformOrigin","text","background","connector","startMarker","endMarker","innerHTML","rest","__rest","some","v","children","forEach","d","remove","_b","backgroundStyle","_d","connectorStyle","endPoints","maybeAppend","style","call","Object","assign","transformOrigin","node","textBaseline","rect","connectorPath","markerStart","id","markerEnd"],"sources":["shape/text/advance.ts"],"sourcesContent":[null],"mappings":";;;;;;;;AASA,SAASA,QAAQ,QAAQ,YAAY;AACrC,SAASC,MAAM,QAAQ,iBAAiB;AACxC,SAASC,IAAI,QAAQ,UAAU;AAE/B,SAASC,aAAa,QAAQ,2BAA2B;AACzD,SAASC,UAAU,QAAQ,UAAU;AACrC,SAASC,SAAS,QAAQ,oBAAoB;AAC9C,SAASC,MAAM,QAAQ,uBAAuB;AAC9C,SAASC,IAAI,QAAQ,oBAAoB;AAmCzC,SAASC,iBAAiBA,CAACC,KAAmB;EAC5C,MAAM;IACJC,GAAG,EAAE,CAACC,EAAE,EAAEC,EAAE,CAAC;IACbC,GAAG,EAAE,CAACC,EAAE,EAAEC,EAAE;EAAC,CACd,GAAGN,KAAK,CAACO,cAAc,EAAE;EAC1B,IAAIC,CAAC,GAAG,CAAC;EACT,IAAIC,CAAC,GAAG,CAAC;EACT,IAAIP,EAAE,GAAG,CAAC,EAAEM,CAAC,GAAGN,EAAE;EAClB,IAAIG,EAAE,GAAG,CAAC,EAAEG,CAAC,GAAGH,EAAE;EAClB,IAAIF,EAAE,GAAG,CAAC,EAAEM,CAAC,GAAGN,EAAE;EAClB,IAAIG,EAAE,GAAG,CAAC,EAAEG,CAAC,GAAGH,EAAE;EAElB,OAAO,CAACE,CAAC,EAAEC,CAAC,CAAC;AACf;AAEA,SAASC,qBAAqBA,CAACC,SAAwB,EAAEC,OAAO,GAAG,EAAE;EACnE,MAAM,CAACC,GAAG,GAAG,CAAC,EAAEC,KAAK,GAAG,CAAC,EAAEC,MAAM,GAAGF,GAAG,EAAEG,IAAI,GAAGF,KAAK,CAAC,GAAGF,OAAO;EAChE,MAAMK,SAAS,GAAGN,SAAS,CAACO,UAA2B;EAEvD,MAAMC,KAAK,GAAGF,SAAS,CAACG,cAAc,EAAE;EACxCH,SAAS,CAACI,cAAc,CAAC,CAAC,CAAC;EAC3B,MAAM;IAAEpB,GAAG;IAAEqB;EAAW,CAAE,GAAGX,SAAS,CAACJ,cAAc,EAAE;EACvD,MAAM,CAACC,CAAC,EAAEC,CAAC,CAAC,GAAGR,GAAG;EAClB,MAAM,CAACsB,EAAE,EAAEC,EAAE,CAAC,GAAGF,WAAW;EAC5BL,SAAS,CAACI,cAAc,CAACF,KAAK,CAAC;EAE/B,OAAO;IACLX,CAAC,EAAEA,CAAC,GAAGQ,IAAI;IACXP,CAAC,EAAEA,CAAC,GAAGI,GAAG;IACVY,KAAK,EAAEF,EAAE,GAAG,CAAC,GAAGP,IAAI,GAAGF,KAAK;IAC5BY,MAAM,EAAEF,EAAE,GAAG,CAAC,GAAGX,GAAG,GAAGE;GACxB;AACH;AAEA,MAAMY,GAAG,GAAGA,CAACC,EAAW,EAAEC,EAAW,EAAEC,EAAW,KAAI;EACpD,MAAMC,CAAC,GAAGjC,IAAI,CAAC8B,EAAE,EAAEC,EAAE,CAAC;EACtB,MAAMG,CAAC,GAAGlC,IAAI,CAAC+B,EAAE,EAAEC,EAAE,CAAC;EACtB,MAAMG,CAAC,GAAGnC,IAAI,CAACgC,EAAE,EAAEF,EAAE,CAAC;EACtB,OAAO,CAACM,IAAA,CAAAC,GAAA,CAAAJ,CAAC,EAAI,CAAC,IAAGG,IAAA,CAAAC,GAAA,CAAAH,CAAC,EAAI,CAAC,IAAGE,IAAA,CAAAC,GAAA,CAAAF,CAAC,EAAI,CAAC,MAAK,CAAC,GAAGF,CAAC,GAAGC,CAAC,CAAC;AACjD,CAAC;AAED,SAASI,kBAAkBA,CACzBpC,KAAoB,EACpBqC,MAAiB,EACjBC,aAAwB,EACxBC,WAAW;EAEX,MAAM,CAAC,CAACrC,EAAE,EAAEC,EAAE,CAAC,EAAE,CAACE,EAAE,EAAEC,EAAE,CAAC,CAAC,GAAG+B,MAAM;EACnC,MAAM,CAAC7B,CAAC,EAAEC,CAAC,CAAC,GAAGV,iBAAiB,CAACC,KAAK,CAAC;EACvC;EACA,IAAIE,EAAE,KAAKG,EAAE,IAAIF,EAAE,KAAKG,EAAE,EAAE;IAC1B,OAAOb,IAAI,EAAE,CAAC,CACZ,CAAC,CAAC,EAAE,CAAC,CAAC,EACN,CAACe,CAAC,EAAEC,CAAC,CAAC,CACP,CAAC;;EAGJ,MAAM+B,CAAC,GAAQ,CAAC,CAACtC,EAAE,GAAGG,EAAE,EAAEF,EAAE,GAAGG,EAAE,CAAC,CAAC,CAACmC,MAAM,CACxCH,aAAa,CAACI,MAAM,GAAGJ,aAAa,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAChD;EAED,MAAMV,EAAE,GAAG,CAACW,WAAW,CAAC,CAAC,CAAC,GAAGlC,EAAE,EAAEkC,WAAW,CAAC,CAAC,CAAC,GAAGjC,EAAE,CAAY;EAChE,MAAM,CAACuB,EAAE,EAAEC,EAAE,CAAC,GAAGU,CAAC;EAClB;EACA,IAAIb,GAAG,CAACC,EAAE,EAAEC,EAAE,EAAEC,EAAE,CAAC,GAAG,CAAC,EAAE;IACvB,MAAMa,EAAE,GAAG,CAAC,MAAK;MACf,MAAM;QAAE1C,GAAG;QAAEG;MAAG,CAAE,GAAGJ,KAAK,CAACO,cAAc,EAAE;MAC3C;MACA,MAAMqC,EAAE,GAAGf,EAAE,CAAC,CAAC,CAAC,GAAI,CAACA,EAAE,CAAC,CAAC,CAAC,GAAGD,EAAE,CAAC,CAAC,CAAC,KAAKC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,IAAKA,EAAE,CAAC,CAAC,CAAC,GAAGD,EAAE,CAAC,CAAC,CAAC,CAAC;MACpE,IAAIxB,GAAG,CAAC,CAAC,CAAC,GAAGwB,EAAE,CAAC,CAAC,CAAC,EAAE,OAAOM,IAAI,CAACjC,GAAG,CAACG,GAAG,CAAC,CAAC,CAAC,EAAEwC,EAAE,CAAC;MAC/C,OAAOV,IAAI,CAAC9B,GAAG,CAACH,GAAG,CAAC,CAAC,CAAC,EAAE2C,EAAE,CAAC;IAC7B,CAAC,EAAC,CAAE;IACJJ,CAAC,CAACK,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAACF,EAAE,EAAE,CAAC,CAAC,CAAC;;EAGzB,OAAOlD,IAAI,EAAE,CAAC+C,CAAC,CAAC;AAClB;AAEA,OAAO,MAAMM,OAAO,GAAGpD,aAAa,CAAEqD,CAAC,IAAI;EACzC,MAAMC,EAAA,GAoBFD,CAAC,CAACE,UAAiC;IApBjC;MACJC,SAAS;MACT;MACAC,KAAK,EAAEC,EAAE;MACTC,SAAS;MACTC,MAAM;MACNC,cAAc;MACdC,oBAAoB;MACpBhD,CAAC;MACDC,CAAC;MACDP,EAAE,GAAGM,CAAC;MACNL,EAAE,GAAGM,CAAC;MACNgD,IAAI;MACJC,UAAU;MACVC,SAAS;MACTC,WAAW;MACXC,SAAS;MACTtB,WAAW;MACXuB;IAAS,IAAAd,EAE4B;IADlCe,IAAI,GAAAC,MAAA,CAAAhB,EAAA,EAnBH,wMAoBL,CAAsC;EAEvC;EACA;EACA,IAAI,CAACxC,CAAC,EAAEC,CAAC,EAAEP,EAAE,EAAEC,EAAE,CAAC,CAAC8D,IAAI,CAAEC,CAAC,IAAK,CAAC3E,QAAQ,CAAC2E,CAAC,CAAC,CAAC,EAAE;IAC5CnB,CAAC,CAACoB,QAAQ,CAACC,OAAO,CAAEC,CAAC,IAAKA,CAAC,CAACC,MAAM,EAAE,CAAC;IACrC;;EAGF,MAAMC,EAAA,GAAkC3E,SAAS,CAACmE,IAAI,EAAE,YAAY,CAAC;IAA/D;MAAEnD;IAAO,IAAA2D,EAAsD;IAAjDC,eAAe,GAAAR,MAAA,CAAAO,EAAA,EAA7B,WAA+B,CAAgC;EACrE,MAAME,EAAA,GAAqC7E,SAAS,CAACmE,IAAI,EAAE,WAAW,CAAC;IAAjE;MAAE1B,MAAM,GAAG;IAAE,IAAAoC,EAAoD;IAA/CC,cAAc,GAAAV,MAAA,CAAAS,EAAA,EAAhC,UAAkC,CAA+B;EACvE,MAAME,SAAS,GAAc,CAC3B,CAAC,CAACzE,EAAE,EAAE,CAACC,EAAE,CAAC,EACV,CAAC,CAACK,CAAC,EAAE,CAACC,CAAC,CAAC,CACT;EAED,IAAIE,SAAS;EACb;EACA,IAAImD,SAAS,EAAE;IACbnD,SAAS,GAAGd,MAAM,CAACkD,CAAC,CAAC,CAClB6B,WAAW,CAAC,MAAM,EAAE,MAAM,EAAE1B,SAAS,CAAC,CACtC2B,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,CAClBA,KAAK,CAAC,WAAW,EAAEf,SAAS,CAAC,CAC7BgB,IAAI,CAACnF,UAAU,EAAAoF,MAAA,CAAAC,MAAA;MACd3B,SAAS,EAAEE,cAAc;MACzB0B,eAAe,EAAEzB;IAAoB,GAClCO,IAAI,EACP,CACDmB,IAAI,EAAE;GACV,MAAM;IACLvE,SAAS,GAAGd,MAAM,CAACkD,CAAC,CAAC,CAClB6B,WAAW,CAAC,MAAM,EAAE,MAAM,CAAC,CAC3BC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,CAClBA,KAAK,CAAC,MAAM,EAAEpB,IAAI,CAAC,CACnBqB,IAAI,CAACnF,UAAU,EAAAoF,MAAA,CAAAC,MAAA;MACdG,YAAY,EAAE,QAAQ;MACtB9B,SAAS,EAAEE,cAAc;MACzB0B,eAAe,EAAEzB;IAAoB,GAClCO,IAAI,EACP,CACDmB,IAAI,EAAE;;EAGX,MAAME,IAAI,GAAGvF,MAAM,CAACkD,CAAC,CAAC,CACnB6B,WAAW,CAAC,YAAY,EAAE,MAAM,CAAC,CACjCC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,CACnBC,IAAI,CAACnF,UAAU,EAAEe,qBAAqB,CAACC,SAAS,EAAEC,OAAO,CAAC,CAAC,CAC3DkE,IAAI,CAACnF,UAAU,EAAE+D,UAAU,GAAGc,eAAe,GAAG,EAAE,CAAC,CACnDU,IAAI,EAAE;EAET,MAAMG,aAAa,GAAGjD,kBAAkB,CACtCgD,IAAI,EACJT,SAAS,EACTtC,MAAM,EACNE,WAAW,CACZ;EACD,MAAM+C,WAAW,GACf1B,WAAW,IACX,IAAIpE,MAAM,CAAC;IACT+F,EAAE,EAAE,aAAa;IACjBV,KAAK,EAAAE,MAAA,CAAAC,MAAA;MAAIxE,CAAC,EAAE,CAAC;MAAEC,CAAC,EAAE;IAAC,GAAMb,SAAS,CAACmE,IAAI,EAAE,aAAa,CAAS;GAChE,CAAC;EACJ,MAAMyB,SAAS,GACb3B,SAAS,IACT,IAAIrE,MAAM,CAAC;IACT+F,EAAE,EAAE,WAAW;IACfV,KAAK,EAAAE,MAAA,CAAAC,MAAA;MAAIxE,CAAC,EAAE,CAAC;MAAEC,CAAC,EAAE;IAAC,GAAMb,SAAS,CAACmE,IAAI,EAAE,WAAW,CAAS;GAC9D,CAAC;EACJlE,MAAM,CAACkD,CAAC,CAAC,CACN6B,WAAW,CAAC,WAAW,EAAE,MAAM,CAAC,CAChCC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,CAClBA,KAAK,CAAC,MAAM,EAAEQ,aAAa,CAAC,CAC5BR,KAAK,CAAC,aAAa,EAAES,WAAW,CAAC,CACjCT,KAAK,CAAC,WAAW,EAAEW,SAAS,CAAC,CAC7BV,IAAI,CAACnF,UAAU,EAAEgE,SAAS,GAAGe,cAAc,GAAG,EAAE,CAAC;AACtD,CAAC,CAAC"},"metadata":{},"sourceType":"module","externalDependencies":[]}