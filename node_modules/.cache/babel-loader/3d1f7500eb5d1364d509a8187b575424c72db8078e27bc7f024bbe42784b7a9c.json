{"ast":null,"code":"import { __awaiter, __generator, __extends, __assign } from 'tslib';\nimport { AbstractRendererPlugin } from '@antv/g-lite';\nimport { distanceSquareRoot } from '@antv/util';\nvar DragndropPlugin = /** @class */function () {\n  function DragndropPlugin(dragndropPluginOptions) {\n    this.dragndropPluginOptions = dragndropPluginOptions;\n  }\n  DragndropPlugin.prototype.apply = function (context) {\n    var _this = this;\n    var renderingService = context.renderingService,\n      renderingContext = context.renderingContext;\n    var document = renderingContext.root.ownerDocument;\n    // TODO: should we add an option like `draggable` to Canvas\n    var canvas = document.defaultView;\n    var handlePointerdown = function (event) {\n      var target = event.target;\n      var isDocument = target === document;\n      var draggableEventTarget = isDocument && _this.dragndropPluginOptions.isDocumentDraggable ? document : target.closest && target.closest('[draggable=true]');\n      // `draggable` may be set on ancestor nodes:\n      // @see https://github.com/antvis/G/issues/1088\n      if (draggableEventTarget) {\n        // delay triggering dragstart event\n        var dragstartTriggered_1 = false;\n        var dragstartTimeStamp_1 = event.timeStamp;\n        var dragstartClientCoordinates_1 = [event.clientX, event.clientY];\n        var currentDroppable_1 = null;\n        var lastDragClientCoordinates_1 = [event.clientX, event.clientY];\n        // @ts-ignore\n        // eslint-disable-next-line no-inner-declarations\n        var handlePointermove_1 = function (event) {\n          return __awaiter(_this, void 0, void 0, function () {\n            var timeElapsed, distanceMoved, point, elementsBelow, elementBelow, droppableBelow;\n            return __generator(this, function (_a) {\n              switch (_a.label) {\n                case 0:\n                  if (!dragstartTriggered_1) {\n                    timeElapsed = event.timeStamp - dragstartTimeStamp_1;\n                    distanceMoved = distanceSquareRoot([event.clientX, event.clientY], dragstartClientCoordinates_1);\n                    // check thresholds\n                    if (timeElapsed <= this.dragndropPluginOptions.dragstartTimeThreshold || distanceMoved <= this.dragndropPluginOptions.dragstartDistanceThreshold) {\n                      return [2 /*return*/];\n                    }\n                    // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragstart_event\n                    event.type = 'dragstart';\n                    draggableEventTarget.dispatchEvent(event);\n                    dragstartTriggered_1 = true;\n                  }\n                  // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/drag_event\n                  event.type = 'drag';\n                  // @ts-ignore\n                  event.dx = event.clientX - lastDragClientCoordinates_1[0];\n                  // @ts-ignore\n                  event.dy = event.clientY - lastDragClientCoordinates_1[1];\n                  draggableEventTarget.dispatchEvent(event);\n                  lastDragClientCoordinates_1 = [event.clientX, event.clientY];\n                  if (!!isDocument) return [3 /*break*/, 2];\n                  point = this.dragndropPluginOptions.overlap === 'pointer' ? [event.canvasX, event.canvasY] : target.getBounds().center;\n                  return [4 /*yield*/, document.elementsFromPoint(point[0], point[1])];\n                case 1:\n                  elementsBelow = _a.sent();\n                  elementBelow = elementsBelow[elementsBelow.indexOf(target) + 1];\n                  droppableBelow = (elementBelow === null || elementBelow === void 0 ? void 0 : elementBelow.closest('[droppable=true]')) || (this.dragndropPluginOptions.isDocumentDroppable ? document : null);\n                  if (currentDroppable_1 !== droppableBelow) {\n                    if (currentDroppable_1) {\n                      // null when we were not over a droppable before this event\n                      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragleave_event\n                      event.type = 'dragleave';\n                      event.target = currentDroppable_1;\n                      currentDroppable_1.dispatchEvent(event);\n                    }\n                    if (droppableBelow) {\n                      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragleave_event\n                      event.type = 'dragenter';\n                      event.target = droppableBelow;\n                      droppableBelow.dispatchEvent(event);\n                    }\n                    currentDroppable_1 = droppableBelow;\n                    if (currentDroppable_1) {\n                      // null if we're not coming over a droppable now\n                      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragover_event\n                      event.type = 'dragover';\n                      event.target = currentDroppable_1;\n                      currentDroppable_1.dispatchEvent(event);\n                    }\n                  }\n                  _a.label = 2;\n                case 2:\n                  return [2 /*return*/];\n              }\n            });\n          });\n        };\n        canvas.addEventListener('pointermove', handlePointermove_1);\n        var stopDragging = function (originalPointerUpEvent) {\n          if (dragstartTriggered_1) {\n            // prevent click event being triggerd\n            // @see https://github.com/antvis/G/issues/1091\n            originalPointerUpEvent.detail = {\n              preventClick: true\n            };\n            // clone event first\n            var event_1 = originalPointerUpEvent.clone();\n            // drop should fire before dragend\n            // @see https://javascript.tutorialink.com/is-there-a-defined-ordering-between-dragend-and-drop-events/\n            if (currentDroppable_1) {\n              // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/drop_event\n              event_1.type = 'drop';\n              event_1.target = currentDroppable_1;\n              currentDroppable_1.dispatchEvent(event_1);\n            }\n            // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragend_event\n            event_1.type = 'dragend';\n            draggableEventTarget.dispatchEvent(event_1);\n            dragstartTriggered_1 = false;\n          }\n          canvas.removeEventListener('pointermove', handlePointermove_1);\n        };\n        target.addEventListener('pointerup', stopDragging, {\n          once: true\n        });\n        target.addEventListener('pointerupoutside', stopDragging, {\n          once: true\n        });\n      }\n    };\n    renderingService.hooks.init.tap(DragndropPlugin.tag, function () {\n      canvas.addEventListener('pointerdown', handlePointerdown);\n    });\n    renderingService.hooks.destroy.tap(DragndropPlugin.tag, function () {\n      canvas.removeEventListener('pointerdown', handlePointerdown);\n    });\n  };\n  DragndropPlugin.tag = 'Dragndrop';\n  return DragndropPlugin;\n}();\nvar Plugin = /** @class */function (_super) {\n  __extends(Plugin, _super);\n  function Plugin(options) {\n    if (options === void 0) {\n      options = {};\n    }\n    var _this = _super.call(this) || this;\n    _this.options = options;\n    _this.name = 'dragndrop';\n    return _this;\n  }\n  Plugin.prototype.init = function () {\n    this.addRenderingPlugin(new DragndropPlugin(__assign({\n      overlap: 'pointer',\n      isDocumentDraggable: false,\n      isDocumentDroppable: false,\n      dragstartDistanceThreshold: 0,\n      dragstartTimeThreshold: 0\n    }, this.options)));\n  };\n  Plugin.prototype.destroy = function () {\n    this.removeAllRenderingPlugins();\n  };\n  Plugin.prototype.setOptions = function (options) {\n    Object.assign(this.plugins[0].dragndropPluginOptions, options);\n  };\n  return Plugin;\n}(AbstractRendererPlugin);\nexport { Plugin };","map":{"version":3,"names":["DragndropPlugin","dragndropPluginOptions","prototype","apply","context","_this","renderingService","renderingContext","document","root","ownerDocument","canvas","defaultView","handlePointerdown","event","target","isDocument","draggableEventTarget","isDocumentDraggable","closest","dragstartTriggered_1","dragstartTimeStamp_1","timeStamp","dragstartClientCoordinates_1","clientX","clientY","currentDroppable_1","lastDragClientCoordinates_1","handlePointermove_1","__awaiter","timeElapsed","distanceMoved","distanceSquareRoot","dragstartTimeThreshold","dragstartDistanceThreshold","type","dispatchEvent","dx","dy","point","overlap","canvasX","canvasY","getBounds","center","elementsFromPoint","elementsBelow","_a","sent","elementBelow","indexOf","droppableBelow","isDocumentDroppable","addEventListener","stopDragging","originalPointerUpEvent","detail","preventClick","event_1","clone","removeEventListener","once","hooks","init","tap","tag","destroy","Plugin","_super","__extends","options","call","name","addRenderingPlugin","__assign","removeAllRenderingPlugins","setOptions","Object","assign","plugins","AbstractRendererPlugin"],"sources":["../src/packages/g-plugin-dragndrop/src/DragndropPlugin.ts","../src/packages/g-plugin-dragndrop/src/index.ts"],"sourcesContent":[null,null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}